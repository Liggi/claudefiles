#!/bin/bash

CLAUDEFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_DIR="$HOME/.claude"
BACKUP_DIR="$HOME/.claude.backup.$(date +%Y%m%d_%H%M%S)"

echo "ü§ñ Setting up claudefiles..."

# Backup existing .claude directory if it exists and is not a symlink
if [[ -d "$CLAUDE_DIR" && ! -L "$CLAUDE_DIR" ]]; then
    echo "üì¶ Backing up existing ~/.claude to $BACKUP_DIR"
    mv "$CLAUDE_DIR" "$BACKUP_DIR"
    echo "   Your previous settings are safe in $BACKUP_DIR"
fi

# Remove existing symlink if present
if [[ -L "$CLAUDE_DIR" ]]; then
    echo "üóëÔ∏è  Removing existing symlink"
    rm "$CLAUDE_DIR"
fi

# Create symlink
echo "üîó Symlinking $CLAUDEFILES_DIR/config ‚Üí ~/.claude"
ln -sf "$CLAUDEFILES_DIR/config" "$CLAUDE_DIR"

# Make hook scripts executable
echo "üîß Making hook scripts executable"
chmod +x "$CLAUDEFILES_DIR/config/hooks"/*.sh 2>/dev/null || true

# Initialize git repo if not already done
if [[ ! -d "$CLAUDEFILES_DIR/.git" ]]; then
    echo "üìÅ Initializing git repository"
    cd "$CLAUDEFILES_DIR"
    git init
    git add .
    git commit -m "Initial claudefiles setup"
fi

# Setup OpenAI CLI with GPT-5
echo "ü§ñ Setting up OpenAI CLI with GPT-5..."

# Install OpenAI Python library
if command -v python3 &> /dev/null; then
    echo "üì¶ Installing/updating OpenAI Python library..."
    python3 -m pip install --user --upgrade openai
    
    # Make gpt5-search executable
    chmod +x "$CLAUDEFILES_DIR/gpt5-search" 2>/dev/null || true
    
    # Add claudefiles to PATH if not already there
    SHELL_RC=""
    if [[ "$SHELL" == */zsh ]]; then
        SHELL_RC="$HOME/.zshrc"
    elif [[ "$SHELL" == */bash ]]; then
        SHELL_RC="$HOME/.bashrc"
    fi
    
    if [[ -n "$SHELL_RC" ]]; then
        if ! grep -q 'claudefiles.*PATH' "$SHELL_RC" 2>/dev/null; then
            echo "üîó Adding claudefiles to PATH in $SHELL_RC..."
            echo 'export PATH="$HOME/claudefiles:$PATH"' >> "$SHELL_RC"
        fi
    fi
    
    # Check for API key
    if [[ -z "${OPENAI_API_KEY}" ]]; then
        echo "‚ö†Ô∏è  Note: Set OPENAI_API_KEY environment variable to use GPT-5"
    else
        echo "‚úÖ OpenAI API key found"
    fi
else
    echo "‚ö†Ô∏è  Python 3 not found - OpenAI CLI setup skipped"
fi

echo "‚úÖ Claudefiles installed successfully!"
echo ""
echo "Next steps:"
echo "  1. Restart Claude Code to apply changes"
echo "  2. Push this repo to GitHub: git remote add origin <your-repo-url>"
echo "  3. Customize settings in claudefiles/config/ as needed"
echo "  4. Source your shell config: source ~/.zshrc (or ~/.bashrc)"
echo ""
echo "Available tools:"
echo "  ‚Ä¢ Claude Code with your custom configuration"
echo "  ‚Ä¢ gpt5-search \"your question\" - GPT-5 with web search"
echo ""
echo "Your development environment is now version controlled! üéâ"